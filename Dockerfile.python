# Python Development Environment
# This Dockerfile creates a dedicated Python development environment
# It includes Python 3.13 and common development tools

FROM python:3.13-slim

# Set working directory
WORKDIR /app

# Install essential build tools and dependencies with cache mount for efficiency
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    apt-get update && apt-get install -y \
    build-essential \
    git \
    curl \
    vim \
    nano \
    less \
    sqlite3 \
    libsqlite3-dev \
    pkg-config \
    postgresql-client \
    libpq-dev \
    redis-tools \
    procps \
    && rm -rf /var/lib/apt/lists/*

# Set up Python virtual environment in /opt/venv
ENV VIRTUAL_ENV=/opt/venv
ENV PATH="$VIRTUAL_ENV/bin:$PATH"

# Create virtual environment
RUN python -m venv $VIRTUAL_ENV

# Copy requirements.txt for Python package management
COPY requirements.txt ./

# Install Python packages with cache mount for faster builds
# Note: Build will fail if any package installation fails (proper production behavior)
# This ensures all dependencies are correctly installed before container is used
RUN --mount=type=cache,target=/root/.cache/pip,sharing=locked \
    pip install --upgrade pip && \
    pip install -r requirements.txt

# Create directories for tutorials, labs, and scripts
RUN mkdir -p /app/python/tutorials /app/python/labs /app/python/reading /app/scripts

# Copy the repository content
COPY . /app/

# Set Python environment variables
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# Set the default command to keep container running
CMD ["tail", "-f", "/dev/null"]
