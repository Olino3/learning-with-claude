version: '3.8'

services:
  # Container for running Ruby scripts
  # Use this for executing .rb files and running applications
  ruby-scripts:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ruby-scripts
    volumes:
      # Mount the entire repository for live code updates
      - .:/app
      # Persist gem installations
      - ruby-bundle:/usr/local/bundle
    working_dir: /app
    command: tail -f /dev/null
    stdin_open: true
    tty: true
    networks:
      - ruby-network

  # Interactive Ruby REPL container
  # Use this for experimenting with Ruby code interactively
  ruby-repl:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ruby-repl
    volumes:
      # Mount the entire repository for access to code examples
      - .:/app
      # Persist gem installations
      - ruby-bundle:/usr/local/bundle
    working_dir: /app
    # Start with an interactive Ruby shell (IRB)
    command: irb
    stdin_open: true
    tty: true
    networks:
      - ruby-network

  # Advanced labs container with isolated environment
  # Use this for running advanced labs that require C extensions, profiling, or concurrency
  ruby-advanced:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ruby-advanced
    volumes:
      # Mount the entire repository
      - .:/app
      # Separate bundle for advanced labs to avoid conflicts
      - ruby-advanced-bundle:/usr/local/bundle
    working_dir: /app
    command: tail -f /dev/null
    stdin_open: true
    tty: true
    # Increased resources for performance profiling and concurrency labs
    cpus: 4
    mem_limit: 2g
    # Additional capabilities for profiling and debugging
    cap_add:
      - SYS_PTRACE
    networks:
      - ruby-network
    environment:
      # Enable YJIT for performance optimization tutorials
      - RUBY_YJIT_ENABLE=1
      # Better garbage collection stats for profiling
      - RUBY_GC_HEAP_GROWTH_FACTOR=1.1
      - RUBY_GC_HEAP_INIT_SLOTS=10000

volumes:
  # Shared volume for gem installations
  ruby-bundle:
    driver: local
  # Separate volume for advanced labs
  ruby-advanced-bundle:
    driver: local

networks:
  ruby-network:
    driver: bridge
